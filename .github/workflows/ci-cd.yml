name: CI/CD Pipeline

on:
  push:
    branches: [ main, 'feature/*' ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      git_tag:
        description: 'Git tag to deploy (e.g., v1.0.0)'
        required: true
        type: string
      target_environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - test
          - prod

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # PR Validation Pipeline
  PR-Validation:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      checks: write
      contents: read
      security-events: write
    steps:
      - name: üîç Checkout Code
        uses: actions/checkout@v4

      - name: ‚òï Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: üì¶ Cache Maven Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: üß™ Run Unit Tests
        run: mvn clean test

      - name: üìä Generate Test Report
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: Maven Unit Test Results
          path: target/surefire-reports/*.xml
          reporter: java-junit

      - name: üîê Run Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'

      - name: üèóÔ∏è Build Validation
        run: mvn clean package -DskipTests

  # Version Detection & Release Management
  Version-Analysis:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/feature/'))
    permissions:
      contents: write  # Needed for creating tags
    outputs:
      version: ${{ steps.version.outputs.version }}
      environment: ${{ steps.version.outputs.environment }}
      should_deploy: ${{ steps.version.outputs.should_deploy }}
      is_release: ${{ steps.version.outputs.is_release }}
      git_tag: ${{ steps.version.outputs.git_tag }}
    steps:
      - name: üîç Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üìä Detect Version Changes & Generate Tags
        id: version
        run: |
          echo "Analyzing version changes..."
          
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            # Main branch - check for version changes in pom.xml
            CURRENT_VERSION=$(grep -oP '<version>\K[^<]+' pom.xml | head -1)
            echo "Current pom.xml version: $CURRENT_VERSION"
          
            # Get previous commit's version
            git checkout HEAD~1 -- pom.xml 2>/dev/null || echo "No previous pom.xml"
            PREVIOUS_VERSION=$(grep -oP '<version>\K[^<]+' pom.xml 2>/dev/null | head -1 || echo "0.0.0")
            git checkout HEAD -- pom.xml
            echo "Previous pom.xml version: $PREVIOUS_VERSION"
          
            if [[ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" && "$CURRENT_VERSION" != *"SNAPSHOT"* ]]; then
              # Version changed and is not a SNAPSHOT - this is a release!
              NEW_VERSION="v$CURRENT_VERSION"
              ENVIRONMENT="dev"
              IS_RELEASE="true"
              SHOULD_DEPLOY="true"
          
              echo "üöÄ Release detected! Version: $NEW_VERSION"
          
              # Create and push git tag
              if ! git tag -l | grep -q "^$NEW_VERSION$"; then
                git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION"
                git push origin "$NEW_VERSION"
                echo "‚úÖ Created and pushed tag: $NEW_VERSION"
              else
                echo "‚ö†Ô∏è Tag $NEW_VERSION already exists"
              fi
          
              echo "git_tag=$NEW_VERSION" >> $GITHUB_OUTPUT
            else
              # Regular main branch commit - patch bump for development
              LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
              LATEST_VERSION=${LATEST_TAG#v}
              IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST_VERSION"
              NEW_VERSION="v${MAJOR}.${MINOR}.$((PATCH + 1))-main-$(git rev-parse --short HEAD)"
              ENVIRONMENT="prod"
              IS_RELEASE="false"
              SHOULD_DEPLOY="true"
              echo "git_tag=" >> $GITHUB_OUTPUT
            fi
          
          elif [[ "${{ github.ref }}" =~ ^refs/heads/feature/ ]]; then
            # Feature branch - preview version
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            LATEST_VERSION=${LATEST_TAG#v}
            IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST_VERSION"
            BRANCH_NAME=$(echo "${{ github.ref }}" | sed 's/refs\/heads\/feature\///')
            NEW_VERSION="v${MAJOR}.${MINOR}.$((PATCH + 1))-feature-${BRANCH_NAME}-$(git rev-parse --short HEAD)"
            ENVIRONMENT="dev"
            IS_RELEASE="false"
            SHOULD_DEPLOY="true"
            echo "git_tag=" >> $GITHUB_OUTPUT
          fi
          
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "is_release=$IS_RELEASE" >> $GITHUB_OUTPUT
          
          echo "üè∑Ô∏è Version: $NEW_VERSION"
          echo "üåç Environment: $ENVIRONMENT"
          echo "üì¶ Is Release: $IS_RELEASE"

  # Manual Deployment from Git Tags
  Manual-Version-Analysis:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    outputs:
      version: ${{ steps.version.outputs.version }}
      environment: ${{ steps.version.outputs.environment }}
      should_deploy: ${{ steps.version.outputs.should_deploy }}
      is_release: ${{ steps.version.outputs.is_release }}
    steps:
      - name: üîç Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git_tag }}

      - name: üìä Validate Tag & Set Version
        id: version
        run: |
          GIT_TAG="${{ github.event.inputs.git_tag }}"
          TARGET_ENV="${{ github.event.inputs.target_environment }}"
          
          # Validate tag exists
          if ! git tag -l | grep -q "^$GIT_TAG$"; then
            echo "‚ùå Tag $GIT_TAG does not exist!"
            exit 1
          fi
          
          echo "version=$GIT_TAG" >> $GITHUB_OUTPUT
          echo "environment=$TARGET_ENV" >> $GITHUB_OUTPUT
          echo "should_deploy=true" >> $GITHUB_OUTPUT
          echo "is_release=true" >> $GITHUB_OUTPUT
          
          echo "üè∑Ô∏è Deploying Tag: $GIT_TAG"
          echo "üåç Target Environment: $TARGET_ENV"

  # Build and Push Container
  Build-and-Push:
    runs-on: ubuntu-latest
    needs: [Version-Analysis, Manual-Version-Analysis]
    if: always() && (needs.Version-Analysis.outputs.should_deploy == 'true' || needs.Manual-Version-Analysis.outputs.should_deploy == 'true')
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: üîç Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.Manual-Version-Analysis.outputs.version || github.sha }}

      - name: ‚òï Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: üì¶ Cache Maven Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: üß™ Run Tests
        run: mvn clean test

      - name: üî® Build Application
        run: |
          VERSION="${{ needs.Manual-Version-Analysis.outputs.version || needs.Version-Analysis.outputs.version }}"
          ENVIRONMENT="${{ needs.Manual-Version-Analysis.outputs.environment || needs.Version-Analysis.outputs.environment }}"
          
          mvn clean package -DskipTests \
            -Dapp.version=$VERSION \
            -Dapp.environment=$ENVIRONMENT

      - name: üîë Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.CR_PAT }}

      - name: üè∑Ô∏è Extract Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ needs.Manual-Version-Analysis.outputs.version || needs.Version-Analysis.outputs.version }}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: üê≥ Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            APP_VERSION=${{ needs.Manual-Version-Analysis.outputs.version || needs.Version-Analysis.outputs.version }}
            APP_ENVIRONMENT=${{ needs.Manual-Version-Analysis.outputs.environment || needs.Version-Analysis.outputs.environment }}

  # Deploy to OpenShift
  Deploy-OpenShift:
    runs-on: self-hosted
    needs: [Version-Analysis, Manual-Version-Analysis, Build-and-Push]
    if: always() && needs.Build-and-Push.result == 'success'
    environment: ${{ needs.Manual-Version-Analysis.outputs.environment || needs.Version-Analysis.outputs.environment }}
    steps:
      - name: üîç Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.Manual-Version-Analysis.outputs.version || github.sha }}

      - name: Check for oc CLI
        id: check-oc
        run: |
          if command -v oc >/dev/null 2>&1; then
            echo "oc_installed=true" >> $GITHUB_OUTPUT
            echo "Current oc version: $(oc version --client)"
          else
            echo "oc_installed=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up OpenShift CLI
        if: steps.check-oc.outputs.oc_installed == 'false'
        uses: redhat-actions/openshift-tools-installer@v1
        with:
          oc: "4.10.0"

      - name: Verify oc installation
        run: |
          oc version --client
          echo "oc CLI successfully installed and working"

      - name: üîê Login to OpenShift
        run: |
          oc login --token=${{ secrets.OPENSHIFT_TOKEN }} --server=${{ secrets.OPENSHIFT_SERVER }} --insecure-skip-tls-verify=true

      - name: üöÄ Deploy Application
        run: |
          VERSION="${{ needs.Manual-Version-Analysis.outputs.version || needs.Version-Analysis.outputs.version }}"
          ENVIRONMENT="${{ needs.Manual-Version-Analysis.outputs.environment || needs.Version-Analysis.outputs.environment }}"
          IS_RELEASE="${{ needs.Manual-Version-Analysis.outputs.is_release || needs.Version-Analysis.outputs.is_release }}"
          
          # Create or switch to project
          PROJECT_NAME="${{ secrets.OPENSHIFT_PROJECT }}"
          oc project $PROJECT_NAME || oc new-project $PROJECT_NAME
          
          echo "üöÄ Deploying $VERSION to $ENVIRONMENT environment"
          if [[ "$IS_RELEASE" == "true" ]]; then
            echo "üì¶ This is a RELEASE deployment"
          else
            echo "üî® This is a DEVELOPMENT deployment"
          fi
          
          # Deploy application
          envsubst < openshift/deployment.yml | oc apply -f -
          envsubst < openshift/service.yml | oc apply -f -
          envsubst < openshift/route.yml | oc apply -f -
          
          # Wait for rollout
          oc rollout status deployment/intflow-service --timeout=300s
        env:
          IMAGE_TAG: ${{ needs.Build-and-Push.outputs.image_tag }}
          APP_VERSION: ${{ needs.Manual-Version-Analysis.outputs.version || needs.Version-Analysis.outputs.version }}
          APP_ENVIRONMENT: ${{ needs.Manual-Version-Analysis.outputs.environment || needs.Version-Analysis.outputs.environment }}

      - name: üß™ Health Check
        run: |
          VERSION="${{ needs.Manual-Version-Analysis.outputs.version || needs.Version-Analysis.outputs.version }}"
          ENVIRONMENT="${{ needs.Manual-Version-Analysis.outputs.environment || needs.Version-Analysis.outputs.environment }}"
          PROJECT_NAME="${{ secrets.OPENSHIFT_PROJECT }}"
          oc project $PROJECT_NAME
          
          echo "üîç Checking application health..."
          
          # Wait for pods to be ready
          sleep 30
          
          # Check deployment status
          oc get deployment/intflow-service -o wide
          
          # Test health endpoint
          ROUTE_URL=$(oc get route intflow-service -o jsonpath='{.spec.host}' 2>/dev/null || echo "")
          if [[ -n "$ROUTE_URL" ]]; then
            echo "üåê Testing at: https://$ROUTE_URL"
            curl -f "http://$ROUTE_URL:8080/api/v1/health" || echo "‚ö†Ô∏è Health check failed"
          else
            echo "‚ö†Ô∏è No external route found"
            oc exec deployment/intflow-service -- curl -f http://localhost:8080/health
          fi

      - name: üéâ Deployment Summary
        run: |
          VERSION="${{ needs.Manual-Version-Analysis.outputs.version || needs.Version-Analysis.outputs.version }}"
          ENVIRONMENT="${{ needs.Manual-Version-Analysis.outputs.environment || needs.Version-Analysis.outputs.environment }}"
          IS_RELEASE="${{ needs.Manual-Version-Analysis.outputs.is_release || needs.Version-Analysis.outputs.is_release }}"
          PROJECT_NAME="${{ secrets.OPENSHIFT_PROJECT }}-$ENVIRONMENT"
          
          echo "üéâ Deployment Complete!"
          echo "‚úÖ Version: $VERSION"
          echo "üåç Environment: $ENVIRONMENT"
          echo "üì¶ Image: ${{ needs.Build-and-Push.outputs.image_tag }}"
          echo "üè∑Ô∏è Release: $IS_RELEASE"
          
          ROUTE_URL=$(oc get route intflow-service -o jsonpath='{.spec.host}' -n $PROJECT_NAME 2>/dev/null || echo "Internal only")
          echo "üîó URL: https://$ROUTE_URL"
          
          if [[ "$IS_RELEASE" == "true" && "$ENVIRONMENT" == "dev" ]]; then
            echo ""
            echo "üöÄ Next Steps for Release Promotion:"
            echo "   1. Validate deployment in dev environment"
            echo "   2. Manual promote to test: Run workflow with tag=$VERSION, env=test"
            echo "   3. Manual promote to prod: Run workflow with tag=$VERSION, env=prod"
          fi

  Post-Deployment-Tests:
    runs-on: self-hosted
    needs: Deploy-OpenShift
    if: needs.Deploy-OpenShift.result == 'success'
    steps:
      - name: üîç Checkout Code
        uses: actions/checkout@v4

      - name: Run Karate Tests
        run: |
          ROUTE_HOST=$(oc get route intflow-service -o jsonpath='{.spec.host}')
          mvn test -Dtest=karate.ApiIntFlowServiceTest -Dkarate.env=dev -Dkarate.options="--tags ~@ignore" \
            -Dkarate.baseUrl=https://$ROUTE_HOST

      - name: Upload Karate Reports
        uses: actions/upload-artifact@v4
        with:
          name: karate-test-reports
          path: |
            target/karate-reports/
            target/surefire-reports/

      - name: Publish Karate Test Summary
        uses: dorny/test-reporter@v1
        with:
          name: Karate Post-Deployment Test Results
          path: target/surefire-reports/*.xml
          reporter: java-junit